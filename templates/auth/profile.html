{% extends 'Home/base.html' %}
{% load static %}

{% block title %}Profile | SU12-Ecommerce{% endblock %}
{% block meta_description %}Manage your account profile{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'main:home' %}">Home</a></li>
<li class="breadcrumb-item active" aria-current="page">Profile</li>
{% endblock %}

{% block content %}
<!-- Profile Section -->
<section class="profile-area section-padding30">
    <div class="container">
        <div class="row">
            <!-- Profile Sidebar -->
            <div class="col-lg-3 col-md-4">
                <div class="profile-sidebar">
                    <div class="profile-avatar text-center mb-30">
                        {% if user.avatar %}
                            <img src="{% static user.avatar %}" alt="Profile Avatar" class="rounded-circle" style="width: 120px; height: 120px; object-fit: cover;">
                        {% elif profile and profile.avatar %}
                            <img src="{% static profile.avatar %}" alt="Profile Avatar" class="rounded-circle" style="width: 120px; height: 120px; object-fit: cover;">
                        {% else %}
                            <div class="default-avatar rounded-circle d-flex align-items-center justify-content-center mx-auto" style="width: 120px; height: 120px; background: #007bff; color: white; font-size: 48px;">
                                {{ user.first_name|first|upper }}{{ user.last_name|first|upper|default:user.username|first|upper }}
                            </div>
                        {% endif %}
                        <h4 class="mt-3">{{ user.get_full_name|default:user.username }}</h4>
                        <p class="text-muted">{{ user.email }}</p>
                    </div>
                    
                    <div class="profile-menu">
                        <ul class="nav flex-column">
                            <li class="nav-item">
                                <a class="nav-link active" href="#profile" data-toggle="tab">Profile</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#orders" data-toggle="tab">Orders</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#wishlist" data-toggle="tab">Wishlist</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#addresses" data-toggle="tab">Addresses</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#settings" data-toggle="tab">Settings</a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Profile Content -->
            <div class="col-lg-9 col-md-8">
                <div class="profile-content">
                    <div class="tab-content">
                        <!-- Profile Tab -->
                        <div class="tab-pane fade show active" id="profile">
                            <div class="tab-header mb-30">
                                <h3>Profile Information</h3>
                                <p>Update your personal information</p>
                            </div>

                            {% if messages %}
                                {% for message in messages %}
                                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                                        {{ message }}
                                        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                            <span aria-hidden="true">&times;</span>
                                        </button>
                                    </div>
                                {% endfor %}
                            {% endif %}

                            <form method="post" enctype="multipart/form-data">
                                {% csrf_token %}
                                <input type="hidden" name="action" value="update_profile">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group mb-20">
                                            <label for="first_name">First Name</label>
                                            <input type="text" class="form-control" id="first_name" name="first_name" value="{{ user.first_name }}" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group mb-20">
                                            <label for="last_name">Last Name</label>
                                            <input type="text" class="form-control" id="last_name" name="last_name" value="{{ user.last_name }}" required>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-group mb-20">
                                    <label for="email">Email Address</label>
                                    <input type="email" class="form-control" id="email" name="email" value="{{ user.email }}" required>
                                </div>

                                <div class="form-group mb-20">
                                    <label for="phone">Phone Number</label>
                                    <input type="tel" class="form-control" id="phone" name="phone" value="{{ user.phone|default:'' }}">
                                </div>
                                
                                {% if not profile %}
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle"></i> Create your profile to save additional information like bio and avatar.
                                </div>
                                {% endif %}

                                <div class="form-group mb-20">
                                    <label for="avatar">Profile Picture</label>
                                    {% if user.avatar %}
                                        <div class="mb-2">
                                            <img src="{% static user.avatar %}" alt="Current Avatar" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover;">
                                        </div>
                                    {% elif profile and profile.avatar %}
                                        <div class="mb-2">
                                            <img src="{% static profile.avatar %}" alt="Current Avatar" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover;">
                                        </div>
                                    {% endif %}
                                    <input type="file" class="form-control-file" id="avatar" name="avatar" accept="image/*">
                                </div>

                                <div class="form-group mb-20">
                                    <label for="bio">Bio</label>
                                    <textarea class="form-control" id="bio" name="bio" rows="3">{% if profile %}{{ profile.bio|default:'' }}{% endif %}</textarea>
                                </div>

                                <button type="submit" class="btn btn-primary">Update Profile</button>
                            </form>
                        </div>

                        <!-- Orders Tab -->
                        <div class="tab-pane fade" id="orders">
                            <div class="tab-header mb-30">
                                <h3>Order History</h3>
                                <p>View your previous orders</p>
                            </div>

                            {% if orders %}
                            <div class="orders-list">
                                {% for order in orders %}
                                <div class="order-item mb-20 p-3 border rounded">
                                    <div class="row align-items-center">
                                        <div class="col-md-3">
                                            <strong>Order #{{ order.order_number|default:order.id }}</strong>
                                            <br>
                                            <small class="text-muted">{% if order.created_at %}{{ order.created_at|date:"M d, Y" }}{% else %}N/A{% endif %}</small>
                                        </div>
                                        <div class="col-md-3">
                                            {% if order.status == 'pending' %}
                                                <span class="badge badge-warning">Pending</span>
                                            {% elif order.status == 'processing' %}
                                                <span class="badge badge-info">Processing</span>
                                            {% elif order.status == 'completed' %}
                                                <span class="badge badge-success">Completed</span>
                                            {% elif order.status == 'cancelled' %}
                                                <span class="badge badge-danger">Cancelled</span>
                                            {% else %}
                                                <span class="badge badge-secondary">{{ order.status|title }}</span>
                                            {% endif %}
                                        </div>
                                        <div class="col-md-3">
                                            <strong>${{ order.total_amount|default:order.subtotal|default:"0.00" }}</strong>
                                        </div>
                                        <div class="col-md-3 text-right">
                                            <a href="{% url 'main:order_detail' order.id %}" class="btn btn-sm btn-outline-primary">View Details</a>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% else %}
                            <div class="text-center py-5">
                                <i class="fas fa-shopping-bag fa-3x text-muted mb-3"></i>
                                <h4>No orders yet</h4>
                                <p class="text-muted">Start shopping to see your order history here.</p>
                                <a href="{% url 'main:shop' %}" class="btn btn-primary">Start Shopping</a>
                            </div>
                            {% endif %}
                        </div>

                        <!-- Wishlist Tab -->
                        <div class="tab-pane fade" id="wishlist">
                            <div class="tab-header mb-30">
                                <h3>My Wishlist</h3>
                                <p>Products you've saved for later</p>
                            </div>

                            {% if wishlist_items %}
                            <div class="row">
                                {% for item in wishlist_items %}
                                <div class="col-lg-4 col-md-6 col-sm-6 mb-30">
                                    <div class="wishlist-item card">
                                        <div class="product-img position-relative">
                                            {% if item.main_image %}
                                                {% if item.main_image|slice:":4" == "http" %}
                                                    <img src="{{ item.main_image }}" alt="{{ item.name }}" class="img-fluid card-img-top" style="height: 200px; object-fit: cover;">
                                                {% else %}
                                                    <img src="{% static item.main_image %}" alt="{{ item.name }}" class="img-fluid card-img-top" style="height: 200px; object-fit: cover;">
                                                {% endif %}
                                            {% endif %}
                                            <div class="product-overlay position-absolute w-100 h-100 d-flex align-items-center justify-content-center" style="top: 0; left: 0; background: rgba(0,0,0,0.5); opacity: 0; transition: opacity 0.3s;">
                                                <div class="overlay-content">
                                                    <a href="{% url 'main:product_detail' item.id %}" class="btn btn-primary btn-sm mb-2">View Details</a>
                                                    <button class="btn btn-secondary btn-sm add-to-cart" data-product-id="{{ item.id }}">Add to Cart</button>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="card-body text-center">
                                            <h5 class="card-title"><a href="{% url 'main:product_detail' item.id %}">{{ item.name }}</a></h5>
                                            <div class="price mb-2">
                                                <span class="current-price">${{ item.price|default:"0.00" }}</span>
                                                {% if item.compare_price and item.compare_price > item.price %}
                                                    <span class="compare-price text-muted text-decoration-line-through ms-2">${{ item.compare_price }}</span>
                                                {% endif %}
                                            </div>
                                            <button class="btn btn-danger btn-sm remove-from-wishlist" data-product-id="{{ item.id }}">
                                                <i class="fas fa-heart-broken"></i> Remove
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% else %}
                            <div class="text-center py-5">
                                <i class="far fa-heart fa-3x text-muted mb-3"></i>
                                <h4>Your wishlist is empty</h4>
                                <p class="text-muted">Start adding products to your wishlist while browsing.</p>
                                <a href="{% url 'main:shop' %}" class="btn btn-primary">Browse Products</a>
                            </div>
                            {% endif %}
                        </div>

                        <!-- Addresses Tab -->
                        <div class="tab-pane fade" id="addresses">
                            <div class="tab-header mb-30">
                                <h3>Addresses</h3>
                                <p>Manage your shipping addresses</p>
                            </div>

                            <div class="row">
                                {% for address in addresses %}
                                <div class="col-md-6 mb-20">
                                    <div class="address-card p-3 border rounded">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <h6>{% if address.address_name %}{{ address.address_name }}{% else %}Address{% endif %}{% if address.is_default %} <span class="badge badge-success">Default</span>{% endif %}</h6>
                                            <div class="address-actions">
                                                <button class="btn btn-sm btn-outline-primary edit-address-btn" data-address-id="{{ address.id }}" 
                                                        data-address-name="{{ address.address_name|default:'' }}" data-first-name="{{ address.first_name }}" data-last-name="{{ address.last_name }}"
                                                        data-address-line1="{{ address.address_line1 }}"
                                                        data-city="{{ address.city }}" data-province="{{ address.state }}" data-postal-code="{{ address.postal_code }}"
                                                        data-phone="{{ address.phone }}" data-is-default="{{ address.is_default }}">Edit</button>
                                                <button class="btn btn-sm btn-outline-danger delete-address-btn" data-address-id="{{ address.id }}">Delete</button>
                                            </div>
                                        </div>
                                        <p class="mb-1"><strong>{{ address.first_name }} {{ address.last_name }}</strong></p>
                                        <p class="mb-1">{{ address.address_line1 }}</p>
                                        <p class="mb-1">{{ address.city }}, {{ address.state }} {{ address.postal_code }}</p>
                                        <p class="mb-0">{{ address.country|default:"Cambodia" }}</p>
                                        <p class="mb-0"><small class="text-muted">Phone: {{ address.phone }}</small></p>
                                    </div>
                                </div>
                                {% empty %}
                                <div class="col-12">
                                    <div class="text-center py-5">
                                        <i class="fas fa-map-marker-alt fa-3x text-muted mb-3"></i>
                                        <h4>No addresses saved</h4>
                                        <p class="text-muted">Add your first shipping address to make checkout easier.</p>
                                        <button class="btn btn-primary" data-toggle="modal" data-target="#addAddressModal">Add Address</button>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>

                            <div class="text-center mt-30">
                                <button class="btn btn-primary" data-toggle="modal" data-target="#addAddressModal">
                                    <i class="fas fa-plus"></i> Add New Address
                                </button>
                            </div>

                            <!-- Address Modal -->
                            <div class="modal fade" id="addAddressModal" tabindex="-1" role="dialog" aria-labelledby="addAddressModalLabel" aria-hidden="true">
                                <div class="modal-dialog" role="document">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title" id="addAddressModalLabel">Add New Address</h5>
                                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                <span aria-hidden="true">&times;</span>
                                            </button>
                                        </div>
                                        <form id="addressForm" onsubmit="handleAddressForm(event)">
                                            {% csrf_token %}
                                            <input type="hidden" name="action" value="save_address">
                                            <input type="hidden" name="address_id" id="address_id" value="">
                                            <div class="modal-body">
                                                <div class="form-group">
                                                    <label for="modal_address_name">Address Name/Label <small class="text-muted">(e.g., Home, Work, Office)</small></label>
                                                    <input type="text" class="form-control" id="modal_address_name" name="address_name" placeholder="e.g., Home, Work, Office">
                                                </div>
                                                <div class="row">
                                                    <div class="col-md-6">
                                                        <div class="form-group">
                                                            <label for="modal_first_name">First Name *</label>
                                                            <input type="text" class="form-control" id="modal_first_name" name="first_name" required>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <div class="form-group">
                                                            <label for="modal_last_name">Last Name *</label>
                                                            <input type="text" class="form-control" id="modal_last_name" name="last_name" required>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="form-group">
                                                    <label for="modal_address_line1">Street Address *</label>
                                                    <input type="text" class="form-control" id="modal_address_line1" name="address_line1" required>
                                                </div>
                                                <div class="row">
                                                    <div class="col-md-6">
                                                        <div class="form-group">
                                                            <label for="modal_city">City/District *</label>
                                                            <input type="text" class="form-control" id="modal_city" name="city" required>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <div class="form-group">
                                                            <label for="modal_province">Province *</label>
                                                            <select class="form-control form-select" id="modal_province" name="province" required style="width: 100%; padding: 8px 12px; font-size: 14px; line-height: 1.5;">
                                                                <option value="">Select Province</option>
                                                                {% for province in cambodia_provinces %}
                                                                    <option value="{{ province }}">{{ province }}</option>
                                                                {% endfor %}
                                                            </select>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="col-md-6">
                                                        <div class="form-group">
                                                            <label for="modal_country">Country *</nlabel>
                                                            <select class="form-control form-select" id="modal_country" name="country" required>
                                                                <option value="Cambodia" selected>Cambodia</option>
                                                                <option value="US">United States</option>
                                                                <option value="CA">Canada</option>
                                                                <option value="UK">United Kingdom</option>
                                                                <option value="AU">Australia</option>
                                                                <option value="DE">Germany</option>
                                                                <option value="FR">France</option>
                                                                <option value="JP">Japan</option>
                                                                <option value="CN">China</option>
                                                                <option value="IN">India</option>
                                                            </select>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <div class="form-group">
                                                            <label for="modal_postal_code">Postal Code</label>
                                                            <input type="text" class="form-control" id="modal_postal_code" name="postal_code">
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="col-md-6">
                    								<div class="form-group">
                                                            <label for="modal_phone">Phone Number *</label>
                                                            <input type="tel" class="form-control" id="modal_phone" name="phone" required>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <div class="form-group">
                                                            <label for="modal_is_default">&nbsp;</label>
                                                            <div class="form-check">
                                                                <input type="checkbox" class="form-check-input" id="modal_is_default" name="is_default">
                                                                <label class="form-check-label" for="modal_is_default">
                                                                    Set as default address
                                                                </label>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="form-check">
                                                    <input type="checkbox" class="form-check-input" id="modal_is_default" name="is_default">
                                                    <label class="form-check-label" for="modal_is_default">
                                                        Set as default address
                                                    </label>
                                                </div>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                                                <button type="submit" class="btn btn-primary">Save Address</button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Settings Tab -->
                        <div class="tab-pane fade" id="settings">
                            <div class="tab-header mb-30">
                                <h3>Account Settings</h3>
                                <p>Manage your account preferences</p>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="settings-section mb-30">
                                        <h5>Password</h5>
                                        <p class="text-muted">Change your account password</p>
                                        <button class="btn btn-outline-primary" data-toggle="modal" data-target="#changePasswordModal">
                                            Change Password
                                        </button>
                                    </div>
                                    
                                    <!-- Change Password Modal -->
                                    <div class="modal fade" id="changePasswordModal" tabindex="-1" role="dialog" aria-labelledby="changePasswordModalLabel" aria-hidden="true">
                                        <div class="modal-dialog" role="document">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h5 class="modal-title" id="changePasswordModalLabel">Change Password</h5>
                                                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                        <span aria-hidden="true">&times;</span>
                                                    </button>
                                                </div>
                                                <form method="post">
                                                    {% csrf_token %}
                                                    <input type="hidden" name="action" value="change_password">
                                                    <div class="modal-body">
                                                        <div class="form-group">
                                                            <label for="old_password">Current Password *</label>
                                                            <input type="password" class="form-control" id="old_password" name="old_password" required>
                                                        </div>
                                                        <div class="form-group">
                                                            <label for="new_password">New Password *</label>
                                                            <input type="password" class="form-control" id="new_password" name="new_password" required minlength="8">
                                                            <small class="form-text text-muted">Password must be at least 8 characters long</small>
                                                        </div>
                                                        <div class="form-group">
                                                            <label for="confirm_password">Confirm New Password *</label>
                                                            <input type="password" class="form-control" id="confirm_password" name="confirm_password" required minlength="8">
                                                        </div>
                                                    </div>
                                                    <div class="modal-footer">
                                                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                                                        <button type="submit" class="btn btn-primary">Change Password</button>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="settings-section mb-30">
                                        <h5>Notifications</h5>
                                        <p class="text-muted">Manage your notification preferences</p>
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input" id="emailNotifications" checked>
                                            <label class="form-check-label" for="emailNotifications">Email Notifications</label>
                                        </div>
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input" id="smsNotifications">
                                            <label class="form-check-label" for="smsNotifications">SMS Notifications</label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="settings-section">
                                <h5>Account Deletion</h5>
                                <p class="text-muted">Permanently delete your account and all associated data</p>
                                <button class="btn btn-danger" data-toggle="modal" data-target="#deleteAccountModal">
                                    Delete Account
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_css %}
<style>
.profile-sidebar {
    background: #fff;
    padding: 30px;
    border-radius: 10px;
    box-shadow: 0 0 20px rgba(0,0,0,0.1);
}

.profile-menu .nav-link {
    color: #333;
    padding: 12px 0;
    border-bottom: 1px solid #eee;
    transition: all 0.3s ease;
}

.profile-menu .nav-link:hover,
.profile-menu .nav-link.active {
    color: #007bff;
    background: none;
    border-left: 3px solid #007bff;
    padding-left: 15px;
}

.profile-content {
    background: #fff;
    padding: 30px;
    border-radius: 10px;
    box-shadow: 0 0 20px rgba(0,0,0,0.1);
}

.tab-header h3 {
    color: #333;
    margin-bottom: 10px;
}

.tab-header p {
    color: #666;
}

.address-card {
    background: #f8f9fa;
    transition: all 0.3s ease;
}

.address-card:hover {
    background: #e9ecef;
    transform: translateY(-2px);
}

.settings-section {
    padding: 20px;
    border: 1px solid #eee;
    border-radius: 8px;
}

.settings-section h5 {
    color: #333;
    margin-bottom: 10px;
}

.settings-section p {
    color: #666;
    margin-bottom: 15px;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Restore active tab from sessionStorage or URL hash
    const activeTab = sessionStorage.getItem('activeProfileTab') || window.location.hash.substring(1) || 'profile';
    if (activeTab) {
        // Remove active class from all tabs and panes
        document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
        document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active', 'show'));
        
        // Activate the correct tab
        const targetTab = document.querySelector(`.nav-link[href="#${activeTab}"]`);
        const targetPane = document.querySelector(`#${activeTab}`);
        if (targetTab && targetPane) {
            targetTab.classList.add('active');
            targetPane.classList.add('active', 'show');
        }
        
        // Clear sessionStorage after restoring
        sessionStorage.removeItem('activeProfileTab');
    }
    
    // Handle wishlist removal
    document.querySelectorAll('.remove-from-wishlist').forEach(btn => {
        btn.addEventListener('click', async function() {
            const productId = this.getAttribute('data-product-id');
            const productCard = this.closest('.wishlist-item');
            
            if (confirm('Are you sure you want to remove this item from your wishlist?')) {
                try {
                    const response = await fetch('{% url "main:remove_wishlist" %}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken')
                        },
                        body: JSON.stringify({ product_id: productId })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        // Remove the card from DOM
                        productCard.remove();
                        
                        // Check if wishlist is now empty
                        const remainingItems = document.querySelectorAll('.wishlist-item');
                        if (remainingItems.length === 0) {
                            location.reload(); // Reload to show empty state
                        }
                    } else {
                        alert(result.message || 'Error removing item from wishlist');
                    }
                } catch (error) {
                    console.error('Error removing from wishlist:', error);
                    alert('Error removing item from wishlist. Please try again.');
                }
            }
        });
    });
    
    // Handle edit address button click - use event delegation to handle dynamically added buttons
    document.addEventListener('click', function(e) {
        if (e.target.closest('.edit-address-btn')) {
            const btn = e.target.closest('.edit-address-btn');
            const addressId = btn.getAttribute('data-address-id');
            document.getElementById('address_id').value = addressId;
            
            // Populate form fields
            document.getElementById('modal_address_name').value = btn.getAttribute('data-address-name') || '';
            document.getElementById('modal_first_name').value = btn.getAttribute('data-first-name') || '';
            document.getElementById('modal_last_name').value = btn.getAttribute('data-last-name') || '';
            document.getElementById('modal_address_line1').value = btn.getAttribute('data-address-line1') || '';
            document.getElementById('modal_city').value = btn.getAttribute('data-city') || '';
            document.getElementById('modal_province').value = btn.getAttribute('data-province') || '';
            document.getElementById('modal_postal_code').value = btn.getAttribute('data-postal-code') || '';
            document.getElementById('modal_phone').value = btn.getAttribute('data-phone') || '';
            document.getElementById('modal_is_default').checked = btn.getAttribute('data-is-default') === 'true';
            
            // Update modal title
            document.getElementById('addAddressModalLabel').textContent = 'Edit Address';
            
            // Show modal
            $('#addAddressModal').modal('show');
        }
    });
    
    // Reset form when modal is closed
    $('#addAddressModal').on('hidden.bs.modal', function() {
        document.getElementById('addressForm').reset();
        document.getElementById('address_id').value = '';
        document.getElementById('addAddressModalLabel').textContent = 'Add New Address';
    });
    
    // Handle add new address button
    document.querySelectorAll('[data-target="#addAddressModal"]').forEach(btn => {
        btn.addEventListener('click', function() {
            document.getElementById('addressForm').reset();
            document.getElementById('address_id').value = '';
            document.getElementById('addAddressModalLabel').textContent = 'Add New Address';
        });
    });
    
    // Handle remove from wishlist
    document.querySelectorAll('.remove-from-wishlist').forEach(btn => {
        btn.addEventListener('click', async function() {
            const productId = this.getAttribute('data-product-id');
            const confirmRemove = confirm('Remove this item from your wishlist?');
            
            if (confirmRemove) {
                try {
                    const response = await fetch('{% url "main:remove_wishlist" %}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken')
                        },
                        body: JSON.stringify({ product_id: productId })
                    });
                    
                    const result = await response.json();
                    if (result.success) {
                        // Reload page to update wishlist
                        window.location.reload();
                    } else {
                        alert(result.message || 'Error removing item from wishlist');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Error removing item from wishlist');
                }
            }
        });
    });
    
    // Handle delete address button click
    document.querySelectorAll('.delete-address-btn').forEach(btn => {
        btn.addEventListener('click', async function() {
            const addressId = this.getAttribute('data-address-id');
            if (!addressId) return;
            
            if (!confirm('Are you sure you want to delete this address? This action cannot be undone.')) {
                return;
            }
            
            const deleteBtn = this;
            const originalText = deleteBtn.innerHTML;
            deleteBtn.disabled = true;
            deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...';
            
            try {
                const response = await fetch('{% url "main:delete_address_mongo" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({ address_id: addressId })
                });
                
                const result = await response.json();
                if (result.success) {
                    // Reload page and stay on addresses tab
                    // Store the tab state in sessionStorage before reload
                    sessionStorage.setItem('activeProfileTab', 'addresses');
                    window.location.hash = 'addresses';
                    // Small delay to ensure hash is set, then reload
                    setTimeout(() => {
                        window.location.reload();
                    }, 100);
                } else {
                    alert(result.message || 'Error deleting address');
                    deleteBtn.disabled = false;
                    deleteBtn.innerHTML = originalText;
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error deleting address. Please try again.');
                deleteBtn.disabled = false;
                deleteBtn.innerHTML = originalText;
            }
        });
    });
    
    // Handle address form submission via AJAX
    window.handleAddressForm = function(event) {
        event.preventDefault();
        const form = document.getElementById('addressForm');
        const formData = new FormData(form);
        const addressId = formData.get('address_id');
        const submitBtn = form.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
        
        // Prepare data for MongoDB API
        const addressData = {
            address_id: addressId || null,
            address_name: formData.get('address_name') || '',
            first_name: formData.get('first_name') || '',
            last_name: formData.get('last_name') || '',
            address_line1: formData.get('address_line1') || '',
            city: formData.get('city') || '',
            province: formData.get('province') || '',
            postal_code: formData.get('postal_code') || '',
            phone: formData.get('phone') || '',
            country: formData.get('country') || 'Cambodia',
            is_default: formData.get('is_default') === 'on'
        };
        
        const url = addressId ? '{% url "main:update_address_mongo" %}' : '{% url "main:save_address" %}';
        
        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(addressData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Close modal
                $('#addAddressModal').modal('hide');
                
                // Reload page and stay on addresses tab
                // Store the tab state in sessionStorage before reload
                sessionStorage.setItem('activeProfileTab', 'addresses');
                window.location.hash = 'addresses';
                // Small delay to ensure hash is set, then reload
                setTimeout(() => {
                    window.location.reload();
                }, 100);
            } else {
                alert(data.message || 'Error saving address');
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error saving address. Please try again.');
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
        });
    };
    
    // Helper function to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // Function to show success message
    function showSuccessMessage(message) {
        // Create a temporary success alert
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-success alert-dismissible fade show';
        alertDiv.style.position = 'fixed';
        alertDiv.style.top = '20px';
        alertDiv.style.right = '20px';
        alertDiv.style.zIndex = '9999';
        alertDiv.style.minWidth = '300px';
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        `;
        document.body.appendChild(alertDiv);
        
        // Auto-dismiss after 3 seconds
        setTimeout(() => {
            if (alertDiv && alertDiv.parentNode) {
                alertDiv.classList.remove('show');
                setTimeout(() => alertDiv.remove(), 150);
            }
        }, 3000);
    }
    
    // Function to add new address card to DOM
    function addAddressCardToDOM(addressData, addressId) {
        const addressesContainer = document.querySelector('#addresses .row');
        if (!addressesContainer) return;
        
        // Remove empty message if it exists
        const emptyMessage = addressesContainer.querySelector('.col-12 .text-center');
        if (emptyMessage) {
            emptyMessage.closest('.col-12').remove();
        }
        
        // Create new address card
        const addressCardHtml = `
            <div class="col-md-6 mb-20" data-address-id="${addressId}">
                <div class="address-card p-3 border rounded">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h6>${addressData.address_name || 'Address'}${addressData.is_default ? ' <span class="badge badge-success">Default</span>' : ''}</h6>
                        <div class="address-actions">
                            <button class="btn btn-sm btn-outline-primary edit-address-btn" data-address-id="${addressId}" 
                                    data-address-name="${addressData.address_name || ''}" data-first-name="${addressData.first_name}" data-last-name="${addressData.last_name}"
                                    data-address-line1="${addressData.address_line1}"
                                    data-city="${addressData.city}" data-province="${addressData.province}" data-postal-code="${addressData.postal_code}"
                                    data-phone="${addressData.phone}" data-is-default="${addressData.is_default || false}">Edit</button>
                            <button class="btn btn-sm btn-outline-danger delete-address-btn" data-address-id="${addressId}">Delete</button>
                        </div>
                    </div>
                    <p class="mb-1"><strong>${addressData.first_name} ${addressData.last_name}</strong></p>
                    <p class="mb-1">${addressData.address_line1}</p>
                    <p class="mb-1">${addressData.city}, ${addressData.province} ${addressData.postal_code || ''}</p>
                    <p class="mb-0">${addressData.country || 'Cambodia'}</p>
                    <p class="mb-0"><small class="text-muted">Phone: ${addressData.phone}</small></p>
                </div>
            </div>
        `;
        
        // Insert before "Add New Address" button container
        const addButtonContainer = addressesContainer.nextElementSibling;
        if (addButtonContainer) {
            addressesContainer.insertAdjacentHTML('beforeend', addressCardHtml);
        } else {
            addressesContainer.insertAdjacentHTML('beforeend', addressCardHtml);
        }
        
        // Re-attach event listeners to the new buttons
        attachAddressEventListeners();
    }
    
    // Function to update existing address card in DOM
    function updateAddressCardInDOM(oldAddressId, addressData, newAddressId) {
        const addressCard = document.querySelector(`[data-address-id="${oldAddressId}"]`);
        if (!addressCard) return;
        
        // Update the card HTML
        const cardContent = addressCard.querySelector('.address-card');
        if (cardContent) {
            cardContent.innerHTML = `
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <h6>${addressData.address_name || 'Address'}${addressData.is_default ? ' <span class="badge badge-success">Default</span>' : ''}</h6>
                    <div class="address-actions">
                        <button class="btn btn-sm btn-outline-primary edit-address-btn" data-address-id="${newAddressId}" 
                                data-address-name="${addressData.address_name || ''}" data-first-name="${addressData.first_name}" data-last-name="${addressData.last_name}"
                                data-address-line1="${addressData.address_line1}"
                                data-city="${addressData.city}" data-province="${addressData.province}" data-postal-code="${addressData.postal_code}"
                                data-phone="${addressData.phone}" data-is-default="${addressData.is_default || false}">Edit</button>
                        <button class="btn btn-sm btn-outline-danger delete-address-btn" data-address-id="${newAddressId}">Delete</button>
                    </div>
                </div>
                <p class="mb-1"><strong>${addressData.first_name} ${addressData.last_name}</strong></p>
                <p class="mb-1">${addressData.address_line1}</p>
                <p class="mb-1">${addressData.city}, ${addressData.province} ${addressData.postal_code || ''}</p>
                <p class="mb-0">${addressData.country || 'Cambodia'}</p>
                <p class="mb-0"><small class="text-muted">Phone: ${addressData.phone}</small></p>
            `;
        }
        
        // Update data-address-id if changed
        if (oldAddressId !== newAddressId) {
            addressCard.setAttribute('data-address-id', newAddressId);
        }
        
        // Re-attach event listeners
        attachAddressEventListeners();
    }
    
    // Function to attach event listeners to address buttons
    function attachAddressEventListeners() {
        // Re-attach delete listeners
        document.querySelectorAll('.delete-address-btn').forEach(btn => {
            if (!btn.hasAttribute('data-listener-attached')) {
                btn.setAttribute('data-listener-attached', 'true');
                btn.addEventListener('click', async function() {
                    const addressId = this.getAttribute('data-address-id');
                    if (!addressId) return;
                    
                    if (!confirm('Are you sure you want to delete this address? This action cannot be undone.')) {
                        return;
                    }
                    
                    const deleteBtn = this;
                    const originalText = deleteBtn.innerHTML;
                    deleteBtn.disabled = true;
                    deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...';
                    
                    try {
                        const response = await fetch('{% url "main:delete_address_mongo" %}', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': getCookie('csrftoken')
                            },
                            body: JSON.stringify({ address_id: addressId })
                        });
                        
                        const result = await response.json();
                        if (result.success) {
                            // Reload page and stay on addresses tab
                            // Store the tab state in sessionStorage before reload
                            sessionStorage.setItem('activeProfileTab', 'addresses');
                            window.location.hash = 'addresses';
                            // Small delay to ensure hash is set, then reload
                            setTimeout(() => {
                                window.location.reload();
                            }, 100);
                        } else {
                            alert(result.message || 'Error deleting address');
                            deleteBtn.disabled = false;
                            deleteBtn.innerHTML = originalText;
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        alert('Error deleting address. Please try again.');
                        deleteBtn.disabled = false;
                        deleteBtn.innerHTML = originalText;
                    }
                });
            }
        });
        
        // Re-attach edit listeners (already handled by existing code, but ensure they work)
        document.querySelectorAll('.edit-address-btn').forEach(btn => {
            if (!btn.hasAttribute('data-listener-attached')) {
                btn.setAttribute('data-listener-attached', 'true');
                // Edit listener is already attached globally above, so we don't need to add it again
            }
        });
    }
});
</script>
{% endblock %}
