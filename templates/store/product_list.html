{% extends 'Home/base.html' %}
{% load static %}

{% block title %}SU12-Ecommerce | Shop{% endblock %}
{% block meta_description %}Browse our collection of fashion items{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'main:home' %}">Home</a></li>
<li class="breadcrumb-item active" aria-current="page">Shop</li>
{% endblock %}

{% block content %}
<!-- Shop Section -->
<section class="shop-area section-padding30">
    <div class="container product-container">
        <style>
            /* Mobile-first responsive design */
            .product-container { max-width: 1400px; }
            

            

            
            /* Progressive Loading Animation */
            .product-item {
                opacity: 0;
                transform: translateY(30px);
                animation: fadeInUp 0.8s ease-out forwards;
            }
            
            @keyframes fadeInUp {
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
            

            
            /* Mobile filter toggle */
            .mobile-filter-toggle {
                display: none;
                background: #007bff;
                color: white;
                border: none;
                padding: 12px 20px;
                border-radius: 8px;
                font-weight: 600;
                margin-bottom: 20px;
                width: 100%;
            }
            
            /* Sidebar responsive */
            .shop-sidebar {
                background: #f8f9fa;
                padding: 20px;
                border-radius: 12px;
                border: 1px solid #e9ecef;
                position: sticky;
                top: 100px;
                height: fit-content;
                max-height: calc(100vh - 120px);
                overflow-y: auto;
                z-index: 100;
                box-shadow: 0 4px 15px rgba(0,0,0,0.1);
                backdrop-filter: blur(10px);
                background: rgba(248, 249, 250, 0.95);
                scrollbar-width: thin;
                scrollbar-color: #007bff #f8f9fa;
            }
            
            .shop-sidebar::-webkit-scrollbar {
                width: 6px;
            }
            
            .shop-sidebar::-webkit-scrollbar-track {
                background: #f8f9fa;
                border-radius: 3px;
            }
            
            .shop-sidebar::-webkit-scrollbar-thumb {
                background: #007bff;
                border-radius: 3px;
            }
            
            .shop-sidebar::-webkit-scrollbar-thumb:hover {
                background: #0056b3;
            }
            
            .sidebar-widget {
                margin-bottom: 25px;
            }
            
            .widget-title {
                font-size: 18px;
                font-weight: 700;
                margin-bottom: 15px;
                color: #333;
                border-bottom: 2px solid #007bff;
                padding-bottom: 8px;
            }
            
            .category-list, .brand-list {
                list-style: none;
                padding: 0;
                margin: 0;
            }
            
            .category-list li, .brand-list li {
                margin-bottom: 8px;
            }
            
            .category-list a {
                color: #555;
                text-decoration: none;
                padding: 8px 12px;
                display: block;
                border-radius: 6px;
                transition: all 0.2s;
            }
            
            .category-list a:hover, .category-list a.active {
                background: #007bff;
                color: white;
            }
            
            .category-list > li {
                position: relative;
            }
            
            .category-list > li > a.has-children {
                position: relative;
                padding-right: 35px;
            }
            
            .category-toggle {
                position: absolute;
                right: 8px;
                top: 50%;
                transform: translateY(-50%);
                width: 20px;
                height: 20px;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                border-radius: 3px;
                transition: background-color 0.2s ease;
                z-index: 1;
            }
            
            .category-toggle:hover {
                background-color: rgba(0, 123, 255, 0.1);
            }
            
            .category-toggle::after {
                content: 'â–¶';
                font-size: 10px;
                color: #666;
                transition: transform 0.3s ease;
            }
            
            .category-list > li.expanded > a.has-children .category-toggle::after {
                transform: rotate(90deg);
            }
            
            .subcategory-list {
                list-style: none;
                padding: 0;
                margin: 0;
                max-height: 0;
                overflow: hidden;
                transition: max-height 0.3s ease, margin 0.3s ease, padding 0.3s ease;
            }
            
            .category-list > li.expanded > .subcategory-list {
                max-height: 1000px;
                margin: 8px 0 0 20px;
                padding: 0;
            }
            
            .subcategory-list li {
                margin-bottom: 6px;
            }
            
            .subcategory-list a {
                color: #666;
                font-size: 14px;
                padding: 6px 12px;
                display: block;
                border-radius: 4px;
                transition: all 0.2s;
            }
            
            .subcategory-list a:hover, .subcategory-list a.active {
                background: #e3f2fd;
                color: #007bff;
                padding-left: 16px;
            }
            
            .price-range {
                padding: 10px 0;
            }
            
            .price-slider {
                width: 100%;
                margin: 10px 0;
            }
            
            .price-values {
                display: flex;
                justify-content: space-between;
                font-weight: 600;
                color: #007bff;
            }
            
            /* Product grid responsive */
            .product-grid .single-product {
                border: 1px solid #eee;
                border-radius: 14px;
                overflow: hidden;
                transition: transform .2s ease, box-shadow .2s ease;
                background: #fff;
                height: 100%;
            }
            
            .product-grid .single-product:hover {
                transform: translateY(-4px);
                box-shadow: 0 6px 20px rgba(0,0,0,.08);
            }
            
            .product-grid .image-wrap {
                display: block;
                position: relative;
                width: 100%;
                padding-top: 133%;
                overflow: hidden;
                background: #f8f8f8;
            }
            
            .product-grid .image-wrap img {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                object-fit: cover;
            }
            
            .product-grid .product-caption {
                padding: 20px 20px 25px;
            }
            
            .product-grid .product-caption h4 {
                font-size: 22px;
                font-weight: 700;
                line-height: 1.35;
                margin-bottom: 12px;
                min-height: 52px;
                letter-spacing: .3px;
            }
            
            .product-grid .price {
                font-size: 20px;
                font-weight: 700;
            }
            
            .product-grid .old-price {
                color: #9aa1a9;
                text-decoration: line-through;
                margin-left: 12px;
                font-weight: 500;
            }
            
            .product-grid .add-to-cart {
                width: 100%;
                margin-top: 16px;
                padding: 20px 18px;
                font-weight: 700;
                border-radius: 20px;
                letter-spacing: .2px;
            }
            
            /* Mobile responsive breakpoints */
            @media (max-width: 767px) {
                .mobile-filter-toggle { display: block; }
                .shop-sidebar { display: none; }
                .shop-sidebar.show { display: block; }
                .product-grid .col-sm-6 { flex: 0 0 50%; max-width: 50%; }
                .product-grid .product-caption h4 { font-size: 18px; min-height: 44px; }
                .product-grid .price { font-size: 18px; }
                .product-grid .add-to-cart { padding: 16px 14px; font-size: 16px; }
            }
            
            @media (min-width: 768px) and (max-width: 991px) {
                .product-grid .col-md-6 { flex: 0 0 50%; max-width: 50%; }
            }
            
            @media (min-width: 992px) {
                .product-grid .col-lg-4 { flex: 0 0 33.3333%; max-width: 33.3333%; }
            }
            
            @media (min-width: 1200px) {
                .product-grid .col-xl-4 { flex: 0 0 33.3333%; max-width: 33.3333%; }
            }

            /* Toast Notification */
            .toast-notification {
                position: fixed;
                top: 80px;
                right: 20px;
                background: #28a745;
                color: white;
                padding: 12px 16px;
                border-radius: 6px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 9999;
                transform: translateY(-100px);
                transition: transform 0.3s ease-in-out;
                max-width: 250px;
                border-left: 3px solid #fff;
                font-size: 14px;
            }

            .toast-notification.show {
                transform: translateY(0);
            }

            .toast-notification::before {
                content: '';
                position: absolute;
                top: -6px;
                right: 15px;
                width: 0;
                height: 0;
                border-left: 6px solid transparent;
                border-right: 6px solid transparent;
                border-bottom: 6px solid var(--arrow-color, #28a745);
            }

            .toast-content {
                display: flex;
                align-items: center;
                gap: 10px;
            }

            .toast-icon {
                font-size: 20px;
                color: #fff;
            }

            .toast-message {
                font-size: 16px;
                font-weight: 600;
            }

            /* Load More Indicator Styles */

            .loading-spinner {
                text-align: center;
                position: relative;
                padding: 20px 0;
            }

            .spinner-ring {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                width: 60px;
                height: 60px;
                border: 4px solid transparent;
                border-top: 4px solid #007bff;
                border-radius: 50%;
                animation: spin 1.5s linear infinite;
            }

            .spinner-ring:nth-child(2) {
                width: 45px;
                height: 45px;
                border-top-color: #28a745;
                animation-delay: 0.2s;
            }

            .spinner-ring:nth-child(3) {
                width: 30px;
                height: 30px;
                border-top-color: #dc3545;
                animation-delay: 0.4s;
            }

            .loading-text {
                margin-top: 90px;
                font-size: 16px;
                font-weight: 600;
                color: #6c757d;
                animation: pulse 2s ease-in-out infinite;
            }

            @keyframes spin {
                0% { transform: translate(-50%, -50%) rotate(0deg); }
                100% { transform: translate(-50%, -50%) rotate(360deg); }
            }

            @keyframes pulse {
                0%, 100% { opacity: 0.6; }
                50% { opacity: 1; }
            }

            /* Product Item Animation */
            .product-item {
                opacity: 0;
                transform: translateY(30px);
                animation: fadeInUp 0.8s ease-out forwards;
            }

            @keyframes fadeInUp {
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            /* Staggered animation delays */
            .product-item:nth-child(1) { animation-delay: 0.1s; }
            .product-item:nth-child(2) { animation-delay: 0.2s; }
            .product-item:nth-child(3) { animation-delay: 0.3s; }
            .product-item:nth-child(4) { animation-delay: 0.4s; }
            .product-item:nth-child(5) { animation-delay: 0.5s; }
            .product-item:nth-child(6) { animation-delay: 0.6s; }
            .product-item:nth-child(7) { animation-delay: 0.7s; }
            .product-item:nth-child(8) { animation-delay: 0.8s; }
            .product-item:nth-child(9) { animation-delay: 0.9s; }
            
            /* Staggered Animation */
            @keyframes fadeInUp {
                from {
                    opacity: 0;
                    transform: translateY(30px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            .product-item {
                animation: fadeInUp 0.6s ease-out forwards;
            }
        </style>
        
        <!-- Mobile Filter Toggle -->
        <button class="mobile-filter-toggle" onclick="toggleFilters()">
            <i class="fas fa-filter"></i> Show/Hide Filters
        </button>
        
        <div class="row mb-40">
            <div class="col-12 text-center">
                <h2 style="font-weight:800; font-size:44px; letter-spacing:.5px;">Shop With Us</h2>
                <p style="color:#6b7280; font-size:16px;">Browse our latest items and find your style.</p>
            </div>
        </div>
        
        <div class="row">
            <!-- Sidebar -->
            <div class="col-lg-3 col-md-4 col-12">
                <div class="shop-sidebar" id="shopSidebar">
                    <!-- Category Filter -->
                    <div class="sidebar-widget">
                        <h3 class="widget-title">Categories</h3>
                        <div class="widget-content">
                            <ul class="category-list">
                                <li><a href="{% url 'main:shop' %}" class="{% if not current_category %}active{% endif %}">All Categories</a></li>
                                {% for category in categories %}
                                    <li class="{% if category.children %}{% for subcat in category.children %}{% if current_category == subcat.id %}expanded{% endif %}{% endfor %}{% if current_category == category.id %}expanded{% endif %}{% endif %}">
                                        <a href="{% url 'main:shop' %}?category={{ category.id }}" 
                                           class="{% if current_category == category.id %}active{% endif %} {% if category.children %}has-children{% endif %}">
                                            {{ category.name }}
                                            {% if category.children %}
                                                <span class="category-toggle" onclick="event.stopPropagation(); toggleCategory(this.closest('li'));"></span>
                                            {% endif %}
                                        </a>
                                        {% if category.children %}
                                            <ul class="subcategory-list">
                                                {% for subcat in category.children %}
                                                    <li>
                                                        <a href="{% url 'main:shop' %}?category={{ subcat.id }}" 
                                                           class="{% if current_category == subcat.id %}active{% endif %}">
                                                            {{ subcat.name }}
                                                        </a>
                                                    </li>
                                                {% endfor %}
                                            </ul>
                                        {% endif %}
                                    </li>
                                {% empty %}
                                    <li class="text-muted">No categories available</li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>

                    <!-- Price Filter -->
                    <div class="sidebar-widget">
                        <h3 class="widget-title">Price Range</h3>
                        <div class="widget-content">
                            <form method="GET" action="{% url 'main:shop' %}">
                                {% if current_category %}<input type="hidden" name="category" value="{{ current_category }}">{% endif %}
                                {% if search_query %}<input type="hidden" name="q" value="{{ search_query }}">{% endif %}
                            <div class="price-range">
                                    <input type="range" min="0" max="100" class="price-slider" id="priceRange" name="max_price" value="{{ request.GET.max_price|default:100 }}">
                                <div class="price-values">
                                    <span>$0</span>
                                        <span id="priceValue">${{ request.GET.max_price|default:100 }}</span>
                                    </div>
                                    <button type="submit" class="btn btn-sm btn-primary mt-2">Apply Price Filter</button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Search Filter -->
                    <div class="sidebar-widget">
                        <h3 class="widget-title">Search Products</h3>
                        <div class="widget-content">
                            <form method="GET" action="{% url 'main:shop' %}">
                                {% if current_category %}<input type="hidden" name="category" value="{{ current_category }}">{% endif %}
                                {% if request.GET.max_price %}<input type="hidden" name="max_price" value="{{ request.GET.max_price }}">{% endif %}
                                <div class="input-group">
                                    <input type="text" class="form-control" name="q" value="{{ search_query }}" placeholder="Search products...">
                                    <button class="btn btn-primary" type="submit">Search</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Product Grid -->
            <div class="col-lg-9 col-md-8 col-12 product-grid">
                <!-- Sort and View Options -->
                <div class="shop-top-bar mb-30">
                    <div class="row align-items-center">
                        <div class="col-lg-6 col-md-6 col-12 mb-2">
                            <div class="shop-top-bar-left">
                                <p>Showing {{ products|length }} of {{ total_products }} results</p>
                            </div>
                        </div>
                        <div class="col-lg-6 col-md-6 col-12">
                            <div class="shop-top-bar-right">
                                <select class="form-control" onchange="sortProducts(this.value)">
                                    <option value="">Sort by: Featured</option>
                                    <option value="price_low">Price: Low to High</option>
                                    <option value="price_high">Price: High to Low</option>
                                    <option value="newest">Newest First</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Products Grid -->
                <div id="products-grid" class="row g-4">
                    {% for product in products %}
                    <div class="col-xl-4 col-lg-4 col-md-6 col-sm-6 product-item" data-delay="{{ forloop.counter0 }}">
                        <div class="single-product">
                            <a class="image-wrap" href="{% url 'main:product_detail' product.id %}">
                                {% if product.main_image %}
                                    {% if product.main_image|slice:':4' == 'http' %}
                                        <img src="{{ product.main_image }}" alt="{{ product.name }}">
                                    {% else %}
                                        <img src="{% get_static_prefix %}{{ product.main_image }}" alt="{{ product.name }}">
                                    {% endif %}
                                {% else %}
                                    <img src="https://zandokh.com/image/cache/catalog/products/2024-08/5152405078/Sport-Life-T-Shirt-With-Print%20(1)-cr-450x672.jpg" alt="{{ product.name }}">
                                {% endif %}
                            </a>
                            <div class="product-caption text-center">
                                <h4><a href="{% url 'main:product_detail' product.id %}">{{ product.name }}</a></h4>
                                <div class="price">
                                    <span class="current-price">${{ product.price }}</span>
                                    {% if product.compare_price %}
                                    <span class="old-price">${{ product.compare_price }}</span>
                                    {% endif %}
                                </div>
                                <button class="btn btn-primary add-to-cart" 
                                        data-product-id="{{ product.id }}" 
                                        data-product-name="{{ product.name }}" 
                                        data-product-price="{{ product.price }}" 
                                        data-product-image="{% if product.main_image %}{% if product.main_image|slice:':4' == 'http' %}{{ product.main_image }}{% else %}{% get_static_prefix %}{{ product.main_image }}{% endif %}{% else %}https://zandokh.com/image/cache/catalog/products/2024-08/5152405078/Sport-Life-T-Shirt-With-Print%20(1)-cr-450x672.jpg{% endif %}">
                                    Add to Cart
                                </button>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="col-12">
                        <div class="text-center">
                            <h3>No products found</h3>
                            <p>Try adjusting your search criteria or browse all categories.</p>
                        </div>
                    </div>
                    {% endfor %}
                </div>






            </div>
        </div>
    </div>
</section>

<script>
// Mobile filter toggle
function toggleFilters() {
    const sidebar = document.getElementById('shopSidebar');
    sidebar.classList.toggle('show');
}

// Category expand/collapse toggle
function toggleCategory(categoryElement) {
    categoryElement.classList.toggle('expanded');
}

// Auto-expand categories that contain the active category
document.addEventListener('DOMContentLoaded', function() {
    const currentCategory = '{{ current_category }}';
    if (currentCategory) {
        // Find all category items
        const categoryItems = document.querySelectorAll('.category-list > li');
        categoryItems.forEach(item => {
            const subcategoryLinks = item.querySelectorAll('.subcategory-list a');
            subcategoryLinks.forEach(link => {
                const href = link.getAttribute('href');
                if (href && href.includes('category=' + currentCategory)) {
                    // This parent contains the active category, expand it
                    item.classList.add('expanded');
                }
            });
        });
    }
});

// Price range slider update
const priceRange = document.getElementById('priceRange');
if (priceRange) {
    priceRange.addEventListener('input', function() {
    document.getElementById('priceValue').textContent = '$' + this.value;
});
}

// Product sorting (you can implement this with AJAX or page reload)
function sortProducts(value) {
    if (value) {
        const url = new URL(window.location);
        url.searchParams.set('sort', value);
        window.location.href = url.toString();
    }
}

// Product Animation Implementation
document.addEventListener('DOMContentLoaded', function() {
    const productsGrid = document.getElementById('products-grid');
    
    // Initialize with staggered animations for all products
    const productItems = document.querySelectorAll('.product-item');
    productItems.forEach((item, index) => {
        const delay = index * 0.2; // 0.2s delay between each product
        item.style.animationDelay = `${delay}s`;
    });
    
    // Attach event listeners to products
    function attachEventListeners() {
        document.querySelectorAll('.add-to-cart').forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                
                const productId = this.getAttribute('data-product-id');
                const productName = this.getAttribute('data-product-name');
                const productPrice = parseFloat(this.getAttribute('data-product-price'));
                const productImage = this.getAttribute('data-product-image');
                
                // Add to cart (using localStorage for now)
                addToCart({
                    id: productId,
                    name: productName,
                    price: productPrice,
                    quantity: 1,
                    size: 'Standard',
                    color: 'Default',
                    image: productImage
                });
                
                // Show toast notification
                showToast('Product added to cart!');
                
                // Update cart count in header
                updateCartCount();
            });
        });
    }
    
    // Initial event listeners
    attachEventListeners();
});

// Add to cart function
async function addToCart(product) {
    let cart = JSON.parse(localStorage.getItem('cart') || '[]');
    
    // Check if product already exists in cart
    const existingItem = cart.find(item => 
        item.id === product.id && 
        item.size === product.size && 
        item.color === product.color
    );
    
    if (existingItem) {
        existingItem.quantity += product.quantity;
    } else {
        cart.push(product);
    }
    
    localStorage.setItem('cart', JSON.stringify(cart));
    
    // Save to server if logged in
    {% if user.is_authenticated %}
    try {
        const response = await fetch('{% url "main:save_cart" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ cart: cart })
        });
        const result = await response.json();
        if (result.success) {
            console.log('Cart saved to MongoDB successfully');
        } else {
            console.error('Failed to save cart:', result.message);
        }
    } catch (error) {
        console.error('Error saving cart to server:', error);
    }
    {% endif %}
    
    // Also call global save function if available
    if (typeof window.saveCartToMongoDB === 'function') {
        await window.saveCartToMongoDB();
    }
}

// Helper function to get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Toast notification function
function showToast(message = 'Added successfully!') {
    // Create toast element if it doesn't exist
    let toast = document.getElementById('toast-notification');
    if (!toast) {
        toast = document.createElement('div');
        toast.id = 'toast-notification';
        toast.className = 'toast-notification';
        toast.innerHTML = `
            <div class="toast-content">
                <i class="fas fa-check-circle toast-icon"></i>
                <span class="toast-message">${message}</span>
            </div>
        `;
        document.body.appendChild(toast);
    } else {
        const toastMessage = toast.querySelector('.toast-message');
        toastMessage.textContent = message;
    }
    
    toast.classList.add('show');
    
    // Auto-hide after 3 seconds
    setTimeout(() => {
        toast.classList.remove('show');
        // Actually remove the toast element after animation
        setTimeout(() => {
            if (toast && toast.parentNode) {
                toast.parentNode.removeChild(toast);
            }
        }, 300); // Wait for animation to complete
    }, 3000);
}

// Update cart count in header
function updateCartCount() {
    const cart = JSON.parse(localStorage.getItem('cart') || '[]');
    const cartCount = document.getElementById('cart-count');
    if (cartCount) {
        // Count total quantity of all items, not just number of unique items
        const totalQuantity = cart.reduce((sum, item) => sum + item.quantity, 0);
        cartCount.textContent = totalQuantity;
    }
}
</script>
{% endblock %}

